{% extends 'admin/base_site.html' %}
{% load i18n static %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'admin/css/forms.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.css">
<style>
    .report-section {
        margin-bottom: 30px;
        background: #fff;
        padding: 20px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .report-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    .report-title {
        font-size: 1.5em;
        margin: 0;
    }
    .date-filter {
        background: #f8f9fa;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
    }
    .date-filter .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: flex-end;
    }
    .date-filter .form-group {
        margin: 0;
        flex: 1;
        min-width: 200px;
    }
    .date-filter label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    .chart-container {
        position: relative;
        height: 400px;
        margin: 20px 0;
    }
    .table-responsive {
        margin: 20px 0;
    }
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .summary-card {
        background: #fff;
        border-radius: 4px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        text-align: center;
    }
    .summary-card h3 {
        margin-top: 0;
        color: #666;
        font-size: 1.1em;
    }
    .summary-card .value {
        font-size: 2em;
        font-weight: bold;
        margin: 10px 0;
    }
    .summary-card .trend {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9em;
    }
    .trend-up {
        color: #28a745;
    }
    .trend-down {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div id="content-main">
    <div class="report-header">
        <h1 class="report-title">Отчет по продажам</h1>
    </div>
    
    <div class="date-filter">
        <form method="get" id="date-filter-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="date_from">Дата с:</label>
                    <input type="date" name="date_from" id="date_from" class="form-control" value="{{ date_from|default:'' }}">
                </div>
                <div class="form-group">
                    <label for="date_to">Дата по:</label>
                    <input type="date" name="date_to" id="date_to" class="form-control" value="{{ date_to|default:'' }}">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Применить фильтр</button>
                    <a href="?" class="btn btn-link">Сбросить</a>
                </div>
            </div>
        </form>
    </div>

    <div class="summary-cards">
        <div class="summary-card">
            <h3>Общая выручка</h3>
            <div class="value">{{ total_revenue|default:0|floatformat:2 }} ₽</div>
            <div class="trend">
                <i class="bi bi-arrow-up-circle-fill trend-up"></i>
                <span>12% за период</span>
            </div>
        </div>
        <div class="summary-card">
            <h3>Количество заказов</h3>
            <div class="value">{{ total_orders|default:0 }}</div>
            <div class="trend">
                <i class="bi bi-arrow-up-circle-fill trend-up"></i>
                <span>8% за период</span>
            </div>
        </div>
        <div class="summary-card">
            <h3>Средний чек</h3>
            <div class="value">{{ average_order|default:0|floatformat:2 }} ₽</div>
            <div class="trend">
                <i class="bi bi-arrow-up-circle-fill trend-up"></i>
                <span>4% за период</span>
            </div>
        </div>
        <div class="summary-card">
            <h3>Товаров продано</h3>
            <div class="value">{{ total_products|default:0 }}</div>
            <div class="trend">
                <i class="bi bi-arrow-up-circle-fill trend-up"></i>
                <span>15% за период</span>
            </div>
        </div>
    </div>

    <div class="report-section">
        <h2>Продажи по дням</h2>
        <div class="chart-container">
            <canvas id="salesChart"></canvas>
        </div>
    </div>

    <div class="report-section">
        <h2>Продажи по категориям</h2>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Категория</th>
                        <th>Количество</th>
                        <th>Выручка</th>
                        <th>Доля</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in sales_by_category %}
                    <tr>
                        <td>{{ item.product__category__name|default:'Без категории' }}</td>
                        <td>{{ item.total_quantity }}</td>
                        <td>{{ item.total_revenue|floatformat:2 }} ₽</td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: {{ item.percentage|default:0 }}%" 
                                     aria-valuenow="{{ item.percentage|default:0 }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    {{ item.percentage|floatformat:1 }}%
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">Нет данных для отображения</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="report-section">
        <h2>Распределение по статусам заказов</h2>
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Статус</th>
                                <th>Количество</th>
                                <th>Доля</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for status in order_statuses %}
                            <tr>
                                <td>{{ status.status_display }}</td>
                                <td>{{ status.count }}</td>
                                <td>{{ status.percentage|floatformat:1 }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extrajs %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Автоматическая отправка формы при изменении дат
        const dateInputs = document.querySelectorAll('#date_from, #date_to');
        dateInputs.forEach(input => {
            input.addEventListener('change', function() {
                document.getElementById('date-filter-form').submit();
            });
        });

        // График продаж по дням
        const salesCtx = document.getElementById('salesChart').getContext('2d');
        const salesChart = new Chart(salesCtx, {
            type: 'line',
            data: {
                labels: {{ sales_dates|safe }},
                datasets: [{
                    label: 'Выручка, ₽',
                    data: {{ sales_values|safe }},
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                    fill: true,
                    backgroundColor: 'rgba(75, 192, 192, 0.1)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Выручка: ' + context.raw.toLocaleString('ru-RU') + ' ₽';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('ru-RU') + ' ₽';
                            }
                        }
                    }
                }
            }
        });

        // Круговая диаграмма статусов заказов
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        const statusChart = new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: {{ status_labels|safe }},
                datasets: [{
                    data: {{ status_data|safe }},
                    backgroundColor: [
                        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796', '#5a5c69'
                    ],
                    hoverBackgroundColor: [
                        '#2e59d9', '#17a673', '#2c9faf', '#dda20a', '#be2617', '#6b6d7d', '#4a4c59'
                    ],
                    hoverBorderColor: "rgba(234, 236, 244, 1)",
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                cutout: '70%',
            }
        });
    });
</script>
{% endblock %}
